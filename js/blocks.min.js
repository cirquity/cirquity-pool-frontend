/*!
 * Cirquity - Cirquity v0.1.0 (https://cirquity.com)
 * Copyright 2020-2020 The Cirquity Developers
 * Licensed under MIT (https://github.com/cirquity/cirquity-pool/blob/master/LICENSE)
 */

!function(t){let o=!1,e=!1,a={},l={};t((function(){currentPage={destroy:function(){},update:function(o){e&&t.updateBlocks(o)}};let s=setInterval((function(){lastStats&&(t.blocksInitTemplate(o,a,l),t.loadTranslations(),clearInterval(s))}),10)})),t.updateBlocks=function(o){let e=o===parentCoin?lastStats:mergedStats[o];e&&(a[o]=!1,e.charts.blocks&&t.blocksGenerateChart(e,a),t.blocksRenderBlocks(e.pool.blocks,e))},t.blocksInitTemplate=function(a,l,s){let n=lastStats.config.coin;if(0===t(`#blocksTabs li:contains(${n})`).length){let o=t("#siblingTemplate").html();Mustache.parse(o);let e=Mustache.render(o,{coin:lastStats.config.coin,active:"active"});t("#blocksContent").append(e);let a=t("#siblingTabTemplate").html();Mustache.parse(a);let l=Mustache.render(a,{coin:lastStats.config.coin,symbol:`(${lastStats.config.symbol})`,active:"active"});t("#blocksTabs").append(l),t.blocksSetup(api,lastStats,s)}if(t.updateText(`blocksTotal${n}`,lastStats.pool.totalBlocks.toString()),lastStats.pool.lastBlockFound){const o=new Date(parseInt(lastStats.pool.lastBlockFound)).toISOString();t(`#lastBlockFound${n}`).timeago("update",o)}else t(`#lastBlockFound${n}`).removeAttr("title").data("ts","").update("Never");if(t.updateText(`blocksTotalSolo${n}`,lastStats.pool.totalBlocksSolo.toString()),lastStats.pool.lastBlockFoundSolo){const o=new Date(parseInt(lastStats.pool.lastBlockFoundSolo)).toISOString();t(`#lastBlockFoundSolo${n}`).timeago("update",o)}else t(`#lastBlockFoundSolo${n}`).removeAttr("title").data("ts","").update("Never");t.updateText(`blocksMaturityCount${n}`,lastStats.config.depth.toString()),t(`#averageLuck${n}`).html(t.formatLuck(lastStats.pool.totalDiff,lastStats.pool.totalShares)),l[lastStats.config.coin]=!1,lastStats.charts.blocks&&t.blocksGenerateChart(lastStats,l),t.blocksRenderBlocks(lastStats.pool.blocks,lastStats),Object.keys(mergedStats).forEach(o=>{if(0===t(`#blocksTabs li:contains(${o})`).length){let e=t("#siblingTemplate").html();Mustache.parse(e);let a=Mustache.render(e,{coin:o});t("#blocksContent").append(a);let l=t("#siblingTabTemplate").html();Mustache.parse(l);let s=Mustache.render(l,{coin:o,symbol:`(${mergedStats[o].config.symbol})`});t("#blocksTabs").append(s),t.blocksSetup(mergedApis[o].api,mergedStats[o])}if(t.updateText(`blocksTotal${o}`,mergedStats[o].pool.totalBlocks.toString()),mergedStats[o].pool.lastBlockFound){const e=new Date(parseInt(mergedStats[o].pool.lastBlockFound)).toISOString();t(`#lastBlockFound${o}`).timeago("update",e)}else t(`#lastBlockFound${o}`).removeAttr("title").data("ts","").update("Never");if(t.updateText(`blocksTotalSolo${o}`,mergedStats[o].pool.totalBlocksSolo.toString()),mergedStats[o].pool.lastBlockFoundSolo){const e=new Date(parseInt(mergedStats[o].pool.lastBlockFoundSolo)).toISOString();t(`#lastBlockFoundSolo${o}`).timeago("update",e)}else t(`#lastBlockFoundSolo${o}`).removeAttr("title").data("ts","").update("Never");t.updateText(`blocksMaturityCount${o}`,mergedStats[o].config.depth.toString()),t(`#averageLuck${o}`).html(t.formatLuck(mergedStats[o].pool.totalDiff,mergedStats[o].pool.totalShares)),l[o]=!1,mergedStats[o].charts.blocks&&t.blocksGenerateChart(mergedStats[o],l),t.blocksRenderBlocks(mergedStats[o].pool.blocks,mergedStats[o])}),t.sortElementList(t("#blocksTabs"),t("#blocksTabs > div"),mergedStats),a||(o=t.blocksRunOnce()),e=!0},t.blocksRenderBlocks=function(o,e){let a=t(`#blocksReport${e.config.coin}_rows`);for(let l=0;l<o.length;l+=2){let s=t.blocksParseBlock(o[l+1],o[l],e),n=JSON.stringify(s),c=document.getElementById(`blockRow${e.config.coin}${s.height}`);if(c&&c.getAttribute("data-json")!==n)t(c).replaceWith(t.blocksGetBlockRowElement(s,n,e));else if(!c){let o=t.blocksGetBlockRowElement(s,n,e),l=!1,c=a.children().get();for(let e=0;e<c.length;e++){if(parseInt(c[e].getAttribute("data-height"))<s.height){l=!0,t(c[e]).before(o);break}}l||a.append(o)}}},t.blocksGetBlockRowElement=function(o,e,a){let l=document.createElement("tr");l.setAttribute("data-json",e),l.setAttribute("data-height",o.height),l.setAttribute("id",`blockRow${a.config.coin}${o.height}`),l.setAttribute("title",o.status),l.className={pending:"pending",unlocked:"unlocked",orphaned:"orphaned"}[o.status];let s="",n="success";return void 0===o.reward?(s="Waiting...",n="warning"):(s=t.getReadableCoin(a,o.reward,null,!0),"0"===s&&(n="danger")),l.innerHTML='<td class="col1">'+t.timeago(new Date(1e3*parseInt(o.time)).toISOString())+'</td><td class="col2"><span class="badge badge-'+n+'">'+s+'</span></td><td class="col3">'+o.height+'</td><td class="col4">'+o.difficulty+'</td><td class="col5">'+t.formatBlockLink(o.hash,a)+'</td><td class="col5" title="Miners Address">'+o.address+'</td><td class="col6" title="'+o.shares+' shares submitted">'+t.formatLuck(o.difficulty,o.shares,o.solo)+'</td><td class="col7">'+o.maturity+"</td>",l},t.blocksGenerateChart=function(o,e){if(e[o.config.coin]||!o.charts.blocks||"undefined"===o.charts.blocks||!o.charts.blocksSolo||"undefined"===o.charts.blocksSolo)return;let a=o.config.blocksChartDays||null,l=t.getTranslation("poolBlocks")?t.getTranslation("poolBlocks"):"Blocks found";a&&(l=1===a?t.getTranslation("blocksFoundLast24")?t.getTranslation("blocksFoundLast24"):"Blocks found in the last 24 hours":t.getTranslation("blocksFoundLastDays")?t.getTranslation("blocksFoundLastDays"):"Blocks found in the last {DAYS} days",l=l.replace("{DAYS}",a)),t.updateText(`blocksChartTitle${o.config.coin}`,l);let s=[],n=[],c=[];for(let t in o.charts.blocks){let e=t;if(a&&1===a){e=t.split(" ")[1].replace(":00","")}s.push(e),n.push(o.charts.blocks[t])}for(let t in o.charts.blocksSolo)c.push(o.charts.blocksSolo[t]);let r=null,i=null,d=null,u=t(`blocksChartObj${o.config.coin}`).siblings("a.chart-style");1===u.length&&(r=u.css("background-color"),i=u.css("border-left-color"),d=parseFloat(u.css("width"))),null===r&&(r="rgba(3, 169, 244, .4)"),null===i&&(i="#03a9f4"),(null===d||isNaN(d))&&(d=1);let k=document.getElementById(`blocksChartObj${o.config.coin}`);if(!k)return;new Chart(k,{type:"bar",data:{labels:s,datasets:[{label:"Prop Blocks",data:n,fill:!1,backgroundColor:r,borderColor:i,borderWidth:d},{label:"Solo Blocks",data:c,fill:!1,backgroundColor:"rgba(0, 230, 64, 1)",borderColor:i,borderWidth:d}]},options:{responsive:!0,maintainAspectRatio:!1,legend:{display:!1},scales:{yAxes:[{ticks:{beginAtZero:!0,userCallback:function(t,o,e){if(Math.floor(t)===t)return t}}}]},layout:{padding:{top:0,left:0,right:0,bottom:0}}}});t(`#blocksChart${o.config.coin}`).show(),e[o.config.coin]=!0},t.blocksParseBlock=function(t,o,e){let a=o.split(":"),l={};l=a[0].includes("solo")||a[0].includes("prop")?{height:parseInt(t),solo:"solo"===a[0],address:a[1],hash:a[2],time:a[3],difficulty:parseInt(a[4]),shares:parseInt(a[5]),orphaned:a[6],reward:a[7]}:{height:parseInt(t),solo:!1,address:"",hash:a[0],time:a[1],difficulty:parseInt(a[2]),shares:parseInt(a[3]),orphaned:a[4],reward:a[5]};let s=e.config.depth-(e.network.height-l.height-1);switch(s>1?l.maturity=s+" to go":1===s?l.maturity="<i class='fa fa-spinner fa-spin'></i>":s<=0&&(l.maturity="<i class='fa fa-unlock-alt'></i>"),l.orphaned){case"0":l.status="unlocked",l.maturity="<i class='fa fa-unlock-alt'></i>";break;case"1":l.status="orphaned",l.maturity="<i class='fa fa-times'></i>",l.reward=0;break;default:l.status="pending"}return l},t.blocksSetup=function(o,e,a){t(`#loadMoreBlocks${e.config.coin}`).click((function(a){a[e.config.coin]&&a[e.config.coin].abort(),a[e.config.coin]=t.ajax({url:o+"/get_blocks",data:{height:t(`#blocksReport${e.config.coin}_rows`).children().last().data("height")},dataType:"json",cache:"false",success:function(o){t.blocksRenderBlocks(o,e)}})}))},t.blocksRunOnce=function(){return t("#blocksTabs a").click((function(o){o.preventDefault(),t(this).tab("show")})),!0}}(jQuery);