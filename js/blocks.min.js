/*!
 * Cirquity - Cirquity v0.1.0 (https://cirquity.com)
 * Copyright 2020-2021 The Cirquity Developers
 * Licensed under MIT (https://github.com/cirquity/cirquity-pool/blob/master/LICENSE)
 */

!function(t){let o=!1,e=!1,l={},s={};t((function(){currentPage={destroy:function(){},update:function(o){e&&t.updateBlocks(o)}};let a=setInterval((function(){lastStats&&(t.blocksInitTemplate(o,l,s),t.loadTranslations(),clearInterval(a))}),10)})),t.updateBlocks=function(o){let e=o===parentCoin?lastStats:mergedStats[o];e&&(l[o]=!1,e.charts.blocks&&t.blocksGenerateChart(e,l),t.blocksRenderBlocks(e.pool.blocks,e))},t.blocksInitTemplate=function(l,s,a){let c=lastStats.config.coin;if(0===t(`#blocksTabs li:contains(${c})`).length){let o=t("#siblingTemplate").html();Mustache.parse(o);let e=Mustache.render(o,{coin:lastStats.config.coin,active:"active"});t("#blocksContent").append(e);let l=t("#siblingTabTemplate").html();Mustache.parse(l);let s=Mustache.render(l,{coin:lastStats.config.coin,symbol:`(${lastStats.config.symbol})`,active:"active"});t("#blocksTabs").append(s),t.blocksSetup(api,lastStats,a)}if(t.updateText(`blocksTotal${c}`,lastStats.pool.totalBlocks.toString()),lastStats.pool.lastBlockFound){const o=new Date(parseInt(lastStats.pool.lastBlockFound)).toISOString();t(`#lastBlockFound${c}`).timeago("update",o)}else t(`#lastBlockFound${c}`).removeAttr("title").data("ts","").update("Never");if(t.updateText(`blocksTotalSolo${c}`,lastStats.pool.totalBlocksSolo.toString()),lastStats.pool.lastBlockFoundSolo){const o=new Date(parseInt(lastStats.pool.lastBlockFoundSolo)).toISOString();t(`#lastBlockFoundSolo${c}`).timeago("update",o)}else t(`#lastBlockFoundSolo${c}`).removeAttr("title").data("ts","").update("Never");t.updateText(`blocksMaturityCount${c}`,lastStats.config.depth.toString());let n=t.formatLuck(lastStats.pool.totalDiff,lastStats.pool.totalShares)+'<small class="text-success">PROP</small> / '+t.formatLuck(lastStats.pool.totalDiffSolo,lastStats.pool.totalSharesSolo)+'<small class="text-success">SOLO</small>';t(`#averageLuck${c}`).html(n),s[lastStats.config.coin]=!1,lastStats.charts.blocks&&t.blocksGenerateChart(lastStats,s),t.blocksRenderBlocks(lastStats.pool.blocks,lastStats),Object.keys(mergedStats).forEach(o=>{if(0===t(`#blocksTabs li:contains(${o})`).length){let e=t("#siblingTemplate").html();Mustache.parse(e);let l=Mustache.render(e,{coin:o});t("#blocksContent").append(l);let s=t("#siblingTabTemplate").html();Mustache.parse(s);let a=Mustache.render(s,{coin:o,symbol:`(${mergedStats[o].config.symbol})`});t("#blocksTabs").append(a),t.blocksSetup(mergedApis[o].api,mergedStats[o])}if(t.updateText(`blocksTotal${o}`,mergedStats[o].pool.totalBlocks.toString()),mergedStats[o].pool.lastBlockFound){const e=new Date(parseInt(mergedStats[o].pool.lastBlockFound)).toISOString();t(`#lastBlockFound${o}`).timeago("update",e)}else t(`#lastBlockFound${o}`).removeAttr("title").data("ts","").update("Never");if(t.updateText(`blocksTotalSolo${o}`,mergedStats[o].pool.totalBlocksSolo.toString()),mergedStats[o].pool.lastBlockFoundSolo){const e=new Date(parseInt(mergedStats[o].pool.lastBlockFoundSolo)).toISOString();t(`#lastBlockFoundSolo${o}`).timeago("update",e)}else t(`#lastBlockFoundSolo${o}`).removeAttr("title").data("ts","").update("Never");t.updateText(`blocksMaturityCount${o}`,mergedStats[o].config.depth.toString()),t(`#averageLuck${o}`).html(t.formatLuck(mergedStats[o].pool.totalDiff,mergedStats[o].pool.totalShares)),s[o]=!1,mergedStats[o].charts.blocks&&t.blocksGenerateChart(mergedStats[o],s),t.blocksRenderBlocks(mergedStats[o].pool.blocks,mergedStats[o])}),t.sortElementList(t("#blocksTabs"),t("#blocksTabs > div"),mergedStats),l||(o=t.blocksRunOnce()),e=!0},t.blocksRenderBlocks=function(o,e){let l=t(`#blocksReport${e.config.coin}_rows`);for(let s=0;s<o.length;s+=2){let a=t.blocksParseBlock(o[s+1],o[s],e),c=JSON.stringify(a),n=document.getElementById(`blockRow${e.config.coin}${a.height}`);if(n&&n.getAttribute("data-json")!==c)t(n).replaceWith(t.blocksGetBlockRowElement(a,c,e));else if(!n){let o=t.blocksGetBlockRowElement(a,c,e),s=!1,n=l.children().get();for(let e=0;e<n.length;e++){if(parseInt(n[e].getAttribute("data-height"))<a.height){s=!0,t(n[e]).before(o);break}}s||l.append(o)}}},t.blocksGetBlockRowElement=function(o,e,l){let s=document.createElement("tr");s.setAttribute("data-json",e),s.setAttribute("data-height",o.height),s.setAttribute("id",`blockRow${l.config.coin}${o.height}`),s.setAttribute("title",o.status),s.className={pending:"pending",unlocked:"unlocked",orphaned:"orphaned"}[o.status];let a="",c="success";return void 0===o.reward?(a="Waiting...",c="warning"):(a=t.getReadableCoin(l,o.reward,null,!0),"0"===a&&(c="danger")),s.innerHTML='<td class="col1">'+t.timeago(new Date(1e3*parseInt(o.time)).toISOString())+'</td><td class="col2"><span class="badge badge-'+c+'">'+a+'</span></td><td class="col3">'+o.height+'</td><td class="col4">'+o.difficulty+'</td><td class="col5">'+t.formatBlockLink(o.hash,l)+'</td><td class="col5" title="Miners Address">'+o.address+'</td><td class="col6" title="'+o.shares+' shares submitted">'+t.formatLuck(o.difficulty,o.shares,o.solo)+'</td><td class="col7">'+o.maturity+"</td>",s},t.blocksGenerateChart=function(o,e){if(e[o.config.coin]||!o.charts.blocks||"undefined"===o.charts.blocks||!o.charts.blocksSolo||"undefined"===o.charts.blocksSolo)return;let l=o.config.blocksChartDays||null,s=t.getTranslation("poolBlocks")?t.getTranslation("poolBlocks"):"Blocks found";l&&(s=1===l?t.getTranslation("blocksFoundLast24")?t.getTranslation("blocksFoundLast24"):"Blocks found in the last 24 hours":t.getTranslation("blocksFoundLastDays")?t.getTranslation("blocksFoundLastDays"):"Blocks found in the last {DAYS} days",s=s.replace("{DAYS}",l)),t.updateText(`blocksChartTitle${o.config.coin}`,s);let a=[],c=[],n=[];for(let t in o.charts.blocks){let e=t;if(l&&1===l){e=t.split(" ")[1].replace(":00","")}a.push(e),c.push(o.charts.blocks[t])}for(let t in o.charts.blocksSolo)n.push(o.charts.blocksSolo[t]);let r=null,i=null,d=null,u=t(`blocksChartObj${o.config.coin}`).siblings("a.chart-style");1===u.length&&(r=u.css("background-color"),i=u.css("border-left-color"),d=parseFloat(u.css("width"))),null===r&&(r="rgba(3, 169, 244, .4)"),null===i&&(i="#03a9f4"),(null===d||isNaN(d))&&(d=1);let k=document.getElementById(`blocksChartObj${o.config.coin}`);if(!k)return;new Chart(k,{type:"bar",data:{labels:a,datasets:[{label:"Prop Blocks",data:c,fill:!1,backgroundColor:r,borderColor:i,borderWidth:d},{label:"Solo Blocks",data:n,fill:!1,backgroundColor:"rgba(0, 230, 64, 1)",borderColor:i,borderWidth:d}]},options:{responsive:!0,maintainAspectRatio:!1,legend:{display:!1},scales:{yAxes:[{ticks:{beginAtZero:!0,userCallback:function(t,o,e){if(Math.floor(t)===t)return t}}}]},layout:{padding:{top:0,left:0,right:0,bottom:0}}}});t(`#blocksChart${o.config.coin}`).show(),e[o.config.coin]=!0},t.blocksParseBlock=function(t,o,e){let l=o.split(":"),s={};s=l[0].includes("solo")||l[0].includes("prop")?{height:parseInt(t),solo:"solo"===l[0],address:l[1],hash:l[2],time:l[3],difficulty:parseInt(l[4]),shares:parseInt(l[5]),orphaned:l[6],reward:l[7]}:{height:parseInt(t),solo:!1,address:"",hash:l[0],time:l[1],difficulty:parseInt(l[2]),shares:parseInt(l[3]),orphaned:l[4],reward:l[5]};let a=e.config.depth-(e.network.height-s.height-1);switch(a>1?s.maturity=a+" to go":1===a?s.maturity="<i class='fa fa-spinner fa-spin'></i>":a<=0&&(s.maturity="<i class='fa fa-unlock-alt'></i>"),s.orphaned){case"0":s.status="unlocked",s.maturity="<i class='fa fa-unlock-alt'></i>";break;case"1":s.status="orphaned",s.maturity="<i class='fa fa-times'></i>",s.reward=0;break;default:s.status="pending"}return s},t.blocksSetup=function(o,e,l){t(`#loadMoreBlocks${e.config.coin}`).click((function(l){l[e.config.coin]&&l[e.config.coin].abort(),l[e.config.coin]=t.ajax({url:o+"/get_blocks",data:{height:t(`#blocksReport${e.config.coin}_rows`).children().last().data("height")},dataType:"json",cache:"false",success:function(o){t.blocksRenderBlocks(o,e)}})}))},t.blocksRunOnce=function(){return t("#blocksTabs a").click((function(o){o.preventDefault(),t(this).tab("show")})),!0}}(jQuery);